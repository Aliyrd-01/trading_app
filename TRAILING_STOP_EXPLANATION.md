# –¢—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø: –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

## üìä –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–µ–π—á–∞—Å:**
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Ä–æ–≤–Ω–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ **–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–π –ø—Ä–∏–±—ã–ª–∏**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ **—Ä–µ–∂–∏–º–µ –∞–Ω–∞–ª–∏–∑–∞/–ø—Ä–æ–≥–Ω–æ–∑–∞**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ **–º–æ–≥ –±—ã –±—ã—Ç—å** —Å—Ç–æ–ø-–ª–æ—Å—Å, –µ—Å–ª–∏ –±—ã —Ü–µ–Ω–∞ –¥–≤–∏–≥–∞–ª–∞—Å—å –≤ –ø—Ä–∏–±—ã–ª—å–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- ‚ùå –ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚ùå –ù–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–æ–ø-–ª–æ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω—ã
- ‚ùå –ù–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å —Ç–æ—Ä–≥–æ–≤—ã–º API –±–∏—Ä–∂–∏
- ‚ùå –ù–µ –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üöÄ –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ú–æ–¥—É–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–Ω—ã (WebSocket)

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∏—Ä–∂–µ (Binance WebSocket API)
2. –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–∏–π —Ü–µ–Ω—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
3. –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –º–∞–∫—Å–∏–º—É–º–æ–≤/–º–∏–Ω–∏–º—É–º–æ–≤
4. –•—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –ë–î

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
# price_monitor.py
import ccxt
import asyncio
from websocket import create_connection

class TrailingStopMonitor:
    def __init__(self, symbol, entry_price, direction, trailing_percent):
        self.symbol = symbol
        self.entry_price = entry_price
        self.direction = direction  # 'long' –∏–ª–∏ 'short'
        self.trailing_percent = trailing_percent
        self.highest_price = entry_price  # –¥–ª—è –ª–æ–Ω–≥–∞
        self.lowest_price = entry_price   # –¥–ª—è —à–æ—Ä—Ç–∞
        self.current_stop_loss = None
        
    def update_price(self, current_price):
        if self.direction == 'long':
            # –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º—É–º
            if current_price > self.highest_price:
                self.highest_price = current_price
                # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å
                profit = current_price - self.entry_price
                trailing_distance = profit * self.trailing_percent
                self.current_stop_loss = self.entry_price + trailing_distance
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å
            if current_price <= self.current_stop_loss:
                return "STOP_HIT"
                
        elif self.direction == 'short':
            # –û–±–Ω–æ–≤–ª—è–µ–º –º–∏–Ω–∏–º—É–º
            if current_price < self.lowest_price:
                self.lowest_price = current_price
                # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å
                profit = self.entry_price - current_price
                trailing_distance = profit * self.trailing_percent
                self.current_stop_loss = self.entry_price - trailing_distance
                
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å
            if current_price >= self.current_stop_loss:
                return "STOP_HIT"
                
        return "ACTIVE"
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å —á–µ—Ä–µ–∑ API

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (Celery/APScheduler)
2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ REST API
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ –≤ –ë–î
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
# scheduled_trailing.py
from apscheduler.schedulers.background import BackgroundScheduler
import ccxt

def check_trailing_stops():
    exchange = ccxt.binance()
    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ –ë–î
    active_positions = get_active_positions_with_trailing()
    
    for position in active_positions:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
        ticker = exchange.fetch_ticker(position.symbol)
        current_price = ticker['last']
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–ø-–ª–æ—Å—Å
        new_stop_loss = calculate_trailing_stop(
            position.entry_price,
            current_price,
            position.direction,
            position.trailing_percent
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏—é
        if should_close_position(current_price, new_stop_loss, position.direction):
            close_position(position, current_price)
        else:
            update_stop_loss(position, new_stop_loss)

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
scheduler = BackgroundScheduler()
scheduler.add_job(check_trailing_stops, 'interval', seconds=5)
scheduler.start()
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–æ—Ä–≥–æ–≤—ã–º –±–æ—Ç–æ–º

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
1. –¢–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Å–Ω–æ–≤–µ python-binance)
2. WebSocket –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ —á–µ—Ä–µ–∑ API –±–∏—Ä–∂–∏
4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏—è–º–∏ —á–µ—Ä–µ–∑ –æ—Ä–¥–µ—Ä–∞ –±–∏—Ä–∂–∏

**–ü—Ä–∏–º–µ—Ä:**
```python
# trading_bot.py
from binance.client import Client
from binance.websocket import BinanceSocketManager

class TradingBot:
    def __init__(self, api_key, api_secret):
        self.client = Client(api_key, api_secret)
        self.bm = BinanceSocketManager(self.client)
        
    def start_trailing_stop(self, symbol, entry_price, direction, trailing_percent):
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º WebSocket –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω—ã
        self.bm.start_symbol_ticker_socket(
            symbol,
            self.on_price_update
        )
        
    def on_price_update(self, msg):
        current_price = float(msg['c'])  # —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
        
        # –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø–∞
        # ...
        
        # –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç —Å—Ç–æ–ø-–ª–æ—Å—Å - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —á–µ—Ä–µ–∑ API
        if stop_loss_hit:
            self.client.create_order(
                symbol=symbol,
                side='SELL' if direction == 'long' else 'BUY',
                type='MARKET',
                quantity=position_size
            )
```

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–¥–ª—è –Ω–∞—á–∞–ª–∞):
1. **–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `active_positions` –≤ –ë–î:**
   ```sql
   CREATE TABLE active_positions (
       id INT PRIMARY KEY AUTO_INCREMENT,
       user_id INT,
       symbol VARCHAR(20),
       direction VARCHAR(10),
       entry_price DECIMAL(20,8),
       current_stop_loss DECIMAL(20,8),
       trailing_percent DECIMAL(5,2),
       status VARCHAR(20),
       created_at DATETIME,
       FOREIGN KEY (user_id) REFERENCES users(id)
   );
   ```

2. **–°–æ–∑–¥–∞—Ç—å API endpoint –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
   ```python
   @app.route("/api/start_trailing_monitor", methods=["POST"])
   def start_trailing_monitor():
       # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –ë–î
       # –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
   ```

3. **–°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (Celery –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ–π Thread):**
   ```python
   def monitor_trailing_stops():
       while True:
           check_all_active_positions()
           time.sleep(5)  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
   ```

### –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Celery** –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
2. **WebSocket** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Binance –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **Trading API** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–π
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
5. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–æ–ø-–ª–æ—Å—Å–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–µ–Ω—å–≥–∞–º–∏ –Ω—É–∂–Ω–∞ —Ç—â–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏
2. **–ó–∞–¥–µ—Ä–∂–∫–∏:** API –∑–∞–ø—Ä–æ—Å—ã –∏–º–µ—é—Ç –∑–∞–¥–µ—Ä–∂–∫—É, WebSocket –±—ã—Å—Ç—Ä–µ–µ
3. **–û—à–∏–±–∫–∏ —Å–µ—Ç–∏:** –ù—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑—Ä—ã–≤–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
4. **–ö–æ–º–∏—Å—Å–∏–∏:** –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏ –±–∏—Ä–∂–∏ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–∏–±—ã–ª–∏
5. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°–Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Ç–∏ (testnet)

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–ª–∏–Ω–≥-—Å—Ç–æ–ø, —è –º–æ–≥—É:
1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ WebSocket
2. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –≤ –ë–î
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º
4. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ç–æ—Ä–≥–æ–≤—ã–º API (–µ—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á–∏)

**–í–∞–∂–Ω–æ:** –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω—É–∂–Ω—ã API –∫–ª—é—á–∏ –æ—Ç –±–∏—Ä–∂–∏ —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Ç–æ—Ä–≥–æ–≤–ª—é.

























