<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Analyzer — Login</title>
  <link rel="stylesheet" href="/static/style.css">

  <style>
    /* === Только для чекбокса "Запомнить меня" === */
    #remember-container {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-top: 10px;
      color: #e8e8e8;
    }

    #rememberMe {
      margin-right: 8px;
      width: 16px;
      height: 16px;
      accent-color: #3fa9f5;
    }
  </style>
</head>
<body id="login-page">
  <div class="login-card">
    <h1>Crypto Analyzer</h1>
    <div class="login-form">
      <label>
        Email:
        <input type="text" id="email" placeholder="Введите email">
      </label>
      <label>
        Пароль:
        <input type="password" id="password" placeholder="Введите пароль">
      </label>

      <div id="remember-container">
        <input type="checkbox" id="rememberMe">
        <label for="rememberMe">Запомнить меня</label>
      </div>

      <button id="loginBtn">Войти</button>
      <p id="errorMsg"></p>
    </div>
  </div>

	  <script>
	const loginBtn = document.getElementById("loginBtn");
	const errorMsg = document.getElementById("errorMsg");
	const rememberMe = document.getElementById("rememberMe");
	const emailInput = document.getElementById("email");
	const passwordInput = document.getElementById("password");

	// Флаги для отслеживания состояния ввода (IME для кириллицы)
	let isComposing = false;
	
	// Обработка событий композиции (IME) для предотвращения зависания при вводе кириллицы
	if (emailInput) {
		emailInput.addEventListener('compositionstart', () => { isComposing = true; });
		emailInput.addEventListener('compositionend', () => { isComposing = false; });
		emailInput.addEventListener('compositionupdate', () => { isComposing = true; });
	}
	
	if (passwordInput) {
		passwordInput.addEventListener('compositionstart', () => { isComposing = true; });
		passwordInput.addEventListener('compositionend', () => { isComposing = false; });
		passwordInput.addEventListener('compositionupdate', () => { isComposing = true; });
	}

	// Флаг для предотвращения множественных отправок
	let isSubmitting = false;
	
	// Функция обработки логина
	async function handleLogin() {
	  // Предотвращаем отправку во время ввода кириллицы или повторную отправку
	  if (isComposing || isSubmitting) {
		return;
	  }
	  
	  isSubmitting = true;
	  loginBtn.disabled = true;
	  errorMsg.textContent = "";

	  const email = emailInput.value.trim();
	  const password = passwordInput.value.trim();

	  if (!email || !password) {
		errorMsg.textContent = "Email и пароль обязательны";
		isSubmitting = false;
		loginBtn.disabled = false;
		return;
	  }

	  try {
		// Кодируем данные в UTF-8 для корректной передачи кириллицы
		const response = await fetch("/api/login", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json; charset=utf-8"
		  },
		  body: JSON.stringify({email, password})
		});

		const data = await response.json();

		if (response.ok && data.ok) {
		  if (rememberMe.checked) {
			// Безопасное сохранение в localStorage с обработкой кириллицы
			try {
			  localStorage.setItem("rememberedUser", JSON.stringify({email, password}));
			} catch (e) {
			  console.warn("Не удалось сохранить в localStorage:", e);
			}
		  } else {
			localStorage.removeItem("rememberedUser");
		  }

		  window.location.href = "/";
		} else {
		  errorMsg.textContent = data.error || "Ошибка авторизации";
		  isSubmitting = false;
		  loginBtn.disabled = false;
		}
	  } catch (e) {
		errorMsg.textContent = "Ошибка соединения с сервером";
		isSubmitting = false;
		loginBtn.disabled = false;
	  }
	}
	
	loginBtn.addEventListener("click", handleLogin);
	
	// Обработка Enter в полях ввода (только если не идет ввод кириллицы)
	if (emailInput) {
		emailInput.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && !isComposing) {
				e.preventDefault();
				handleLogin();
			}
		});
	}
	
	if (passwordInput) {
		passwordInput.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && !isComposing) {
				e.preventDefault();
				handleLogin();
			}
		});
	}

	// Автологин при наличии localStorage
	window.addEventListener("load", async () => {
	  try {
		const stored = localStorage.getItem("rememberedUser");
		if (stored) {
		  const data = JSON.parse(stored);
		  const res = await fetch("/api/login", {
			method: "POST",
			headers: {"Content-Type": "application/json; charset=utf-8"},
			body: JSON.stringify({ email: data.email, password: data.password })
		  });
		  const result = await res.json();
		  if (res.ok && result.ok) {
			window.location.href = "/";
		  }
		} else {
		  const res = await fetch("/session_check");
		  const data = await res.json();
		  if (data.logged_in) window.location.href = "/";
		}
	  } catch (e) {
		console.error("Session check failed:", e);
	  }
	});

	</script>
</body>
</html>
