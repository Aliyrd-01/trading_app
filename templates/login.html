<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Analyzer ‚Äî Login</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="{{ url_for('static', filename='translations.js') }}"></script>

  <style>
    /* === –¢–æ–ª—å–∫–æ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ "–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è" === */
    #remember-container {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-top: 10px;
      color: #e8e8e8;
    }

    #rememberMe {
      margin-right: 12px;
      width: 16px;
      height: 16px;
      accent-color: #3fa9f5;
    }
  </style>
</head>
<body id="login-page">
  <div style="position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; align-items: center; gap: 10px;">
    <div class="custom-dropdown" id="languageDropdown">
      <button class="custom-dropdown-toggle" id="languageToggleBtn" type="button">
        <span id="languageToggleText">üåê</span>
      </button>
      <ul class="custom-dropdown-menu" id="languageDropdownMenu">
        <li data-value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</li>
        <li data-value="en">English</li>
        <li data-value="ru" class="selected">–†—É—Å—Å–∫–∏–π</li>
      </ul>
    </div>
  </div>
  
  <div class="login-card">
    <h1>Crypto Analyzer</h1>
    <div class="login-form">
      <label>
        <span id="emailLabel">Email:</span>
        <input type="text" id="email" placeholder="–í–≤–µ–¥–∏—Ç–µ email">
      </label>
      <label>
        <span id="passwordLabel">–ü–∞—Ä–æ–ª—å:</span>
        <input type="password" id="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
      </label>

      <div id="remember-container" style="display: flex; align-items: center; font-size: 14px; margin-top: 10px; color: #e8e8e8;">
        <input type="checkbox" id="rememberMe" style="margin-right: 12px !important; width: 16px; height: 16px; accent-color: #3fa9f5; vertical-align: middle; margin: 0;">
        <label for="rememberMe" id="rememberLabel" style="margin: 0; padding: 0; vertical-align: middle; line-height: 16px; display: flex; align-items: center;">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
      </div>

      <button id="loginBtn">–í–æ–π—Ç–∏</button>
      <p id="errorMsg"></p>
    </div>
  </div>

	  <script>
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–∑—ã–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞
	let currentLanguage = localStorage.getItem('language') || 'ru';
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –¥–ª—è —è–∑—ã–∫–∞
	function initLoginCustomDropdown() {
	  const dropdown = document.getElementById('languageDropdown');
	  const toggle = document.getElementById('languageToggleBtn');
	  const menu = document.getElementById('languageDropdownMenu');
	  const toggleText = document.getElementById('languageToggleText');
	  
	  if (!dropdown || !toggle || !menu) return;
	  
	  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫
	  const currentLang = localStorage.getItem('language') || 'ru';
	  updateDropdownText(currentLang);
	  
	  // –û—Ç–º–µ—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
	  menu.querySelectorAll('li').forEach(li => {
		if (li.getAttribute('data-value') === currentLang) {
		  li.classList.add('selected');
		} else {
		  li.classList.remove('selected');
		}
	  });
	  
	  // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
	  toggle.addEventListener('click', (e) => {
		e.stopPropagation();
		menu.classList.toggle('show');
	  });
	  
	  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
	  document.addEventListener('click', (e) => {
		if (!dropdown.contains(e.target)) {
		  menu.classList.remove('show');
		}
	  });
	  
	  // –í—ã–±–æ—Ä —è–∑—ã–∫–∞
	  menu.querySelectorAll('li').forEach(li => {
		li.addEventListener('click', () => {
		  const value = li.getAttribute('data-value');
		  currentLanguage = value;
		  localStorage.setItem('language', value);
		updateLoginTranslations();
		  updateDropdownText(value);
		  menu.classList.remove('show');
		  
		  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
		  menu.querySelectorAll('li').forEach(item => {
			item.classList.remove('selected');
		  });
		  li.classList.add('selected');
		});
	  });
	  
	  function updateDropdownText(lang) {
		const langMap = {
		  'uk': 'UA',
		  'en': 'EN',
		  'ru': 'RU'
		};
		if (toggleText) {
		  toggleText.textContent = langMap[lang] || 'üåê';
		}
	  }
	}
	
	function updateLoginTranslations() {
	  const t = translations[currentLanguage] || translations['ru'] || {};
	  
	  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç—ã
	  const emailLabel = document.getElementById('emailLabel');
	  if (emailLabel) emailLabel.textContent = (t.email || 'Email') + ':';
	  
	  const passwordLabel = document.getElementById('passwordLabel');
	  if (passwordLabel) passwordLabel.textContent = (t.password || '–ü–∞—Ä–æ–ª—å') + ':';
	  
	  const loginBtn = document.getElementById('loginBtn');
	  if (loginBtn) loginBtn.textContent = t.login || '–í–æ–π—Ç–∏';
	  
	  const rememberLabel = document.getElementById('rememberLabel');
	  if (rememberLabel) rememberLabel.textContent = t.remember_me || '–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è';
	  
	  // –û–±–Ω–æ–≤–ª—è–µ–º placeholder
	  const emailInput = document.getElementById('email');
	  if (emailInput) emailInput.placeholder = t.email_placeholder || '–í–≤–µ–¥–∏—Ç–µ email';
	  
	  const passwordInput = document.getElementById('password');
	  if (passwordInput) passwordInput.placeholder = t.password_placeholder || '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
	}
	
	// –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
	if (typeof translations !== 'undefined') {
	  updateLoginTranslations();
	}
	
	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥—Ä–æ–ø–¥–∞—É–Ω
	initLoginCustomDropdown();
	
	const loginBtn = document.getElementById("loginBtn");
	const errorMsg = document.getElementById("errorMsg");
	const rememberMe = document.getElementById("rememberMe");
	const emailInput = document.getElementById("email");
	const passwordInput = document.getElementById("password");

	// –§–ª–∞–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–≤–æ–¥–∞ (IME –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
	let isComposing = false;
	let isSubmitting = false;
	
	// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ (IME) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
	if (emailInput) {
		emailInput.addEventListener('compositionstart', () => { isComposing = true; });
		emailInput.addEventListener('compositionend', () => { isComposing = false; });
		emailInput.addEventListener('compositionupdate', () => { isComposing = true; });
	}
	
	if (passwordInput) {
		passwordInput.addEventListener('compositionstart', () => { isComposing = true; });
		passwordInput.addEventListener('compositionend', () => { isComposing = false; });
		passwordInput.addEventListener('compositionupdate', () => { isComposing = true; });
	}

	// –ê–≤—Ç–æ–ª–æ–≥–∏–Ω –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ localStorage
	window.addEventListener("load", async () => {
	  try {
		const stored = localStorage.getItem("rememberedUser");
		if (stored) {
		  const data = JSON.parse(stored);
		  const res = await fetch("/api/login", {
			method: "POST",
			headers: {"Content-Type": "application/json; charset=utf-8"},
			body: JSON.stringify({ email: data.email, password: data.password })
		  });
		  const result = await res.json();
		  if (res.ok && result.ok) {
			window.location.href = "/";
		  }
		} else {
		  const res = await fetch("/session_check");
		  const data = await res.json();
		  if (data.logged_in) window.location.href = "/";
		}
	  } catch (e) {
		console.error("Session check failed:", e);
	  }
	});

	// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–æ–≥–∏–Ω–∞
	async function handleLogin() {
	  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤–æ –≤—Ä–µ–º—è –≤–≤–æ–¥–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
	  if (isComposing || isSubmitting) {
		return;
	  }
	  
	  isSubmitting = true;
	  loginBtn.disabled = true;
	  errorMsg.textContent = "";

	  const email = emailInput.value.trim();
	  const password = passwordInput.value.trim();

	  if (!email || !password) {
		errorMsg.textContent = "Email –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã";
		isSubmitting = false;
		loginBtn.disabled = false;
		return;
	  }

	  try {
		// –ö–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ UTF-8 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
		const response = await fetch("/api/login", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json; charset=utf-8"
		  },
		  body: JSON.stringify({email, password})
		});

		const data = await response.json();

		if (response.ok && data.ok) {
		  if (rememberMe.checked) {
			// –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
			try {
			  localStorage.setItem("rememberedUser", JSON.stringify({email, password}));
			} catch (e) {
			  console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage:", e);
			}
		  } else {
			localStorage.removeItem("rememberedUser");
		  }

		  window.location.href = "/";
		} else {
		  errorMsg.textContent = data.error || "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏";
		  isSubmitting = false;
		  loginBtn.disabled = false;
		}
	  } catch (e) {
		errorMsg.textContent = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º";
		isSubmitting = false;
		loginBtn.disabled = false;
	  }
	}
	
	loginBtn.addEventListener("click", handleLogin);
	
	// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –∏–¥–µ—Ç –≤–≤–æ–¥ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
	if (emailInput) {
		emailInput.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && !isComposing) {
				e.preventDefault();
				handleLogin();
			}
		});
	}
	
	if (passwordInput) {
		passwordInput.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && !isComposing) {
				e.preventDefault();
				handleLogin();
			}
		});
	}
	</script>
</body>
</html>
